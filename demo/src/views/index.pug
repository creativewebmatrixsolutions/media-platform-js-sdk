doctype html
html()
    head
        title Wix Media Platform - Demo

        script(src='/media-platform.min.js')
    body
        h2 Image

        h3 Success
        #image

        script.
            var ImageRequest = MP.image.ImageRequest;
            var ImageDTO = MP.image.ImageDTO;
            var imageRequest = new ImageRequest('media.wixapps.net/wixmedia-samples/images', '000c45e21f8a433cb3b2483dfbb659d8');

        script.
            var elem = document.createElement('img');
            elem.src = imageRequest.fit(500, 500).negative().saturation(-90).toUrl().url;
            document.getElementById('image').appendChild(elem);

        h3 Error
        #error

        script.
            var error = imageRequest.fill(250, 250).contrast(-200).toUrl().error;
            document.getElementById('error').innerHTML = error.message;

        h2 Upload
        #upload

            form(id='upload-form' enctype='multipart/form-data' action='' method='post' target='upload-result')
                input(id='file' name='file' type='file' accept='image/*')
                input(id='media-type' name='media_type' type='text' value='picture' hidden)
                input(id='upload-token' name='upload_token' type='text' hidden)

            button(id='upload-button').
                Upload


        h3 Upload Result
        #upload-result-container

        script.
            var button = document.getElementById('upload-button');
            button.addEventListener('click', function () {
                fetch('http://localhost:3333/upload/picture/credentials').then(function (response) {
                    response.json().then(function (uploadCredentials) {
                        var form = document.getElementById('upload-form');

                        var formData = new FormData(form);
                        formData.set('upload_token', uploadCredentials.uploadToken);

                        var request = new XMLHttpRequest();
                        request.responseType = 'json';
                        request.addEventListener('load', function (event) {

                            var imageDto = new ImageDTO(event.target.response[0]);
                            var imageRequest = new ImageRequest().fromDTO('media.wixapps.net/', imageDto);
                            var imageUrl = imageRequest.crop(800, 200, 1, 1).toUrl();

                            var container = document.getElementById('upload-result-container');
                            while (container.firstChild) {
                                container.removeChild(container.firstChild);
                            }
                            var img = document.createElement('img');
                            img.setAttribute('src', imageUrl.url);
                            var pre = document.createElement('pre');
                            pre.innerText = JSON.stringify(event.target.response[0], null, 2);
                            container.appendChild(img);
                            container.appendChild(pre);
                        });

                        request.addEventListener('error', function (event) {
                            alert('Oops! Something went wrong.');
                        });

                        request.open('POST', uploadCredentials.uploadUrl);
                        request.send(formData);
                    })
                })
            })